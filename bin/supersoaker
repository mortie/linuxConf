#!/bin/sh

if ! [ -t 1 ]; then
	eval "$@"
	exit $?
fi

reader() {
	text=""
	numlines=0
	done=1

	while read -r line; do
		text="$text$line
"
		numlines=$(($numlines + 1))
		printf "%s\n" "$line"

		if [ "$numlines" -gt 10 ]; then
			done=0
			echo "(Output too long, redirecting to pager...)"
			break
		fi
	done

	if [ $done = 1 ]; then
		exit 0
	fi

	(printf "%s" "$text"; cat) | less -R
}

script -qfe --command "$@" | reader
stty sane

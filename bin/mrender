#!/bin/bash

TMP=$(mktemp /tmp/mrender.XXXXXXXX.pdf)
DIR=$(pwd)

function render()
{
	C=$(cat "$1")
	F=$(echo -n "$C" | mformat)
	cd ~
	echo -n "$F"
	echo -n "$F" | pandoc --latex-engine=pdflatex -B "$HOME/bin/mrender.tex" -o "$2"
	cd "$DIR"
}

function fileinfo()
{
	ls -l --time-style=full-iso "$1"
}

trap "rm \"$TMP\"; exit 0" 2

FILE="$1"

if [ "$FILE" = "" ]; then
	FILE="-"
fi

render "$FILE" "$TMP"

if [ "$1" = "" ]; then
	zathura "$TMP"
	rm "$TMP"

elif [ "$2" = "" ]; then
	zathura "$TMP" &
	PID="$!"

	sleep 1;
	OLD=$(ls -R --full-time "$FILE")
	while :; do
		NEW=$(ls -R --full-time "$FILE")

		# Rerender if file changes
		if [ "$OLD" != "$NEW" ]; then
			echo "File changed, rerendering."
			OLD="$NEW"
			render "$FILE" "$TMP"
		fi

		# Die if zathura dies
		if ! kill -0 "$PID" > /dev/null 2>&1; then
			rm "$TMP"
			exit 0
		fi

		sleep 0.1
	done

	rm "$TMP"

else
	mv "$TMP" "$2"
fi
